<html ng-app="clioBucketsApp">
  <head>
    <title> Clio Buckets </title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
    <script src="/app.js"></script>
    <style>
      table, th, td {
        border: 1px solid black;
      }
      html {
        font-family: "Comic Sans MS", "Comic Sans", cursive;
      }

    </style>
  </head>
  <body>
    <h1> The app </h1>  
    <h3 ng-controller="LogoutDirective as ctrl"> 
      <a href="#logout" ng-click="ctrl.logout()"> Logout </a>
    </h3>
    <div ng-controller="StupidController as ctrl">
      <label> Department
        <select
           ng-model="ctrl.departmentId"
           ng-options="option.id as option.name for option in ctrl.departments">
        </select>
      </label>
      <label ng-if="ctrl.departmentId"> Action
        <select
           ng-model="ctrl.action"
           ng-change="ctrl.selectAction(ctrl.action)">
          <option value="Competencies"> Competencies </option>
          <option value="Users"> Users </option>
        </select>
      </label>

      <div ng-if="ctrl.action == 'Competencies'">
        <h2> Competencies <a href> New </a>  </h2>
        <label ng-if="ctrl.departmentId"> Rank
          <select
             ng-model="ctrl.competencyRank"
             ng-options="key as value for (key, value) in ctrl.rankMap">
          </select>
        </label>
        <table>
          <tr>
            <th> Rank </th>
            <th> Competency </th>
            <th> Category </th>
            <th> 
              Actions
            </th>
          </tr>
          <tr ng-repeat="c in ctrl.competencies | filter: { rank: ctrl.competencyRank}  | orderBy: ['rank', 'category', 'name']">
            <td> {{ ctrl.rankMap[c.rank] }} </td>
            <td> {{ c.name }} </td>
            <td> {{ c.category }} </td>
            <td> 
              <a href> Edit </a> 
            </td>
          </tr>
        </table>
      </div>

      <div ng-if="ctrl.action == 'Users'">
        <label> Users
          <select
             ng-model="ctrl.user"
             ng-change="ctrl.selectUser()"
             ng-options="option as option.full_name for option in ctrl.users">
          </select>
        </label>
        <div ng-if="ctrl.user && ctrl.directReports[ctrl.user.id]">
          <label> Update Roles
            <select
               multiple="multiple"
               ng-model="ctrl.user.roles"
               ng-options="option as option.name for option in ctrl.roles track by option.id">
            </select>
          </label>
          <button ng-click="ctrl.updateUserRoles()"> Update </button>
        </div>
        <div ng-if="ctrl.user && ctrl.directReports[ctrl.user.id] && ctrl.recommendedGrants">
          <h3> Recommendations </h3>
          <dl>
            <dt ng-repeat-start="grant in ctrl.recommendedGrants">
              {{ grant.granter.full_name }}
            </dt>
            <dd ng-repeat-end>
              <p> Reason: {{ grant.reason }} </p>
              <p> Actions: <a href="#" ng-click="ctrl.updateGrant(grant.id, true)"> Approve </a> or <a href="#" ng-click="ctrl.updateGrant(grant.id, false)"> Reject </a> </p>
            </dd>
          </dl>
        </div>
        <table ng-if="ctrl.user">
          <tr>
            <th> Rank </th>
            <th> Competency </th>
            <th> Category </th>
            <th> Granted? </th>
            <th> Actions </th>
          </tr>
          <tr ng-repeat="c in ctrl.userCompetencies | orderBy: ['rank', 'category', 'name']">
            <td> {{ ctrl.rankMap[c.rank] }} </td>
            <td> {{ c.name }} </td>
            <td> {{ c.category }} </td>
            <td> {{ ctrl.competenciesGranted[c.id] || "No" }} </td>
            <td> 
              <a 
                 ng-if="ctrl.userDepartmentId == ctrl.departmentId && (!ctrl.competenciesGranted[c.id] || ctrl.competenciesGranted[c.id] === 'No')" 
                 href="#" 
                 ng-click="ctrl.createGrant(c.id)"> 
                {{ ctrl.directReports[ctrl.user.id] ? 'Grant' : 'Recommend' }}
              </a> 
            </td>
          </tr>
        </table>
      </div>
    </div>
  </body>
</html>
